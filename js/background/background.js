console.log('Salam semangat!');

window.dakron = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/dakron.js');
window.custom = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/custom.min.js');
window.style2 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style2.js');
window.style3 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style3.js');
window.style4 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style4.js');
window.style5 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style5.js');
window.style6 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style6.js');
window.style7 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style7.js');
window.style8 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style8.js');
window.style9 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style9.js');
window.style10 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style10.js');
window.style11 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style11.js');
window.style12 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style12.js');
window.style13 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style13.js');
window.style14 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style14.js');
window.style15 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style15.js');
window.style16 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style16.js');
window.style17 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style17.js');
window.style18 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style18.js');
window.style19 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style19.js');
window.style20 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style20.js');
window.style21 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style21.js');
window.style22 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style22.js');
window.style23 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style23.js');
window.style24 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style24.js');
window.style25 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style25.js');
window.style26 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style26.js');
window.style27 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style27.js');
window.style28 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style28.js');
window.style29 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style29.js');
window.style30 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style30.js');
window.style31 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style31.js');
window.style32 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style32.js');
window.style33 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style33.js');
window.style34 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style34.js');
window.style35 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style35.js');
window.style36 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style36.js');
window.style37 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style37.js');
window.style38 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style38.js');
window.style39 = '';
loadUnBlock('https://sipd.kemendagri.go.id/assets/js/jquery.style39.js');

function listener(details) {
	loadUnBlock(details.url);
	if(details.url.indexOf('dakron.js') != -1){
		return {redirectUrl: "data:text/html,"+dakron+";"};
    }else if(details.url.indexOf('custom.min.js') != -1){
		return {redirectUrl: "data:text/html,"+custom+";"};
    }else if(details.url.indexOf('jquery.style2.js') != -1){
		return {redirectUrl: "data:text/html,"+style2+";"};
    }else if(details.url.indexOf('jquery.style3.js') != -1){
		return {redirectUrl: "data:text/html,"+style3+";"};
    }else if(details.url.indexOf('jquery.style4.js') != -1){
		return {redirectUrl: "data:text/html,"+style4+";"};
    }else if(details.url.indexOf('jquery.style5.js') != -1){
		return {redirectUrl: "data:text/html,"+style5+";"};
    }else if(details.url.indexOf('jquery.style6.js') != -1){
		return {redirectUrl: "data:text/html,"+style6+";"};
    }else if(details.url.indexOf('jquery.style7.js') != -1){
		return {redirectUrl: "data:text/html,"+style7+";"};
    }else if(details.url.indexOf('jquery.style8.js') != -1){
		return {redirectUrl: "data:text/html,"+style8+";"};
    }else if(details.url.indexOf('jquery.style9.js') != -1){
		return {redirectUrl: "data:text/html,"+style9+";"};
    }else if(details.url.indexOf('jquery.style10.js') != -1){
		return {redirectUrl: "data:text/html,"+style10+";"};
    }else if(details.url.indexOf('jquery.style11.js') != -1){
		return {redirectUrl: "data:text/html,"+style11+";"};
    }else if(details.url.indexOf('jquery.style12.js') != -1){
		return {redirectUrl: "data:text/html,"+style12+";"};
    }else if(details.url.indexOf('jquery.style13.js') != -1){
		return {redirectUrl: "data:text/html,"+style13+";"};
    }else if(details.url.indexOf('jquery.style14.js') != -1){
		return {redirectUrl: "data:text/html,"+style14+";"};
    }else if(details.url.indexOf('jquery.style15.js') != -1){
		return {redirectUrl: "data:text/html,"+style15+";"};
    }else if(details.url.indexOf('jquery.style16.js') != -1){
		return {redirectUrl: "data:text/html,"+style16+";"};
    }else if(details.url.indexOf('jquery.style17.js') != -1){
		return {redirectUrl: "data:text/html,"+style17+";"};
    }else if(details.url.indexOf('jquery.style18.js') != -1){
		return {redirectUrl: "data:text/html,"+style18+";"};
    }else if(details.url.indexOf('jquery.style19.js') != -1){
		return {redirectUrl: "data:text/html,"+style19+";"};
    }else if(details.url.indexOf('jquery.style20.js') != -1){
		return {redirectUrl: "data:text/html,"+style20+";"};
    }else if(details.url.indexOf('jquery.style21.js') != -1){
		return {redirectUrl: "data:text/html,"+style21+";"};
    }else if(details.url.indexOf('jquery.style22.js') != -1){
		return {redirectUrl: "data:text/html,"+style22+";"};
    }else if(details.url.indexOf('jquery.style23.js') != -1){
		return {redirectUrl: "data:text/html,"+style23+";"};
    }else if(details.url.indexOf('jquery.style24.js') != -1){
		return {redirectUrl: "data:text/html,"+style24+";"};
    }else if(details.url.indexOf('jquery.style25.js') != -1){
		return {redirectUrl: "data:text/html,"+style25+";"};
    }else if(details.url.indexOf('jquery.style26.js') != -1){
		return {redirectUrl: "data:text/html,"+style26+";"};
    }else if(details.url.indexOf('jquery.style27.js') != -1){
		return {redirectUrl: "data:text/html,"+style27+";"};
    }else if(details.url.indexOf('jquery.style28.js') != -1){
		return {redirectUrl: "data:text/html,"+style28+";"};
    }else if(details.url.indexOf('jquery.style29.js') != -1){
		return {redirectUrl: "data:text/html,"+style29+";"};
    }else if(details.url.indexOf('jquery.style30.js') != -1){
		return {redirectUrl: "data:text/html,"+style30+";"};
    }else if(details.url.indexOf('jquery.style31.js') != -1){
		return {redirectUrl: "data:text/html,"+style31+";"};
    }else if(details.url.indexOf('jquery.style32.js') != -1){
		return {redirectUrl: "data:text/html,"+style32+";"};
    }else if(details.url.indexOf('jquery.style33.js') != -1){
		return {redirectUrl: "data:text/html,"+style33+";"};
    }else if(details.url.indexOf('jquery.style34.js') != -1){
		return {redirectUrl: "data:text/html,"+style34+";"};
    }else if(details.url.indexOf('jquery.style35.js') != -1){
		return {redirectUrl: "data:text/html,"+style35+";"};
    }else if(details.url.indexOf('jquery.style36.js') != -1){
		return {redirectUrl: "data:text/html,"+style36+";"};
    }else if(details.url.indexOf('jquery.style37.js') != -1){
		return {redirectUrl: "data:text/html,"+style37+";"};
    }else if(details.url.indexOf('jquery.style38.js') != -1){
		return {redirectUrl: "data:text/html,"+style38+";"};
    }else if(details.url.indexOf('jquery.style39.js') != -1){
		return {redirectUrl: "data:text/html,"+style39+";"};
    }
}

chrome.webRequest.onBeforeRequest.addListener(
  listener,
  {
    urls: [
    	"https://*.sipd.kemendagri.go.id/assets/js/dakron.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/custom.min.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style2.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style3.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style4.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style5.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style6.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style7.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style8.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style9.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style10.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style11.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style12.js",
    	"https://*.sipd.kemendagri.go.id/assets/js/jquery.style13.js"
    ],
    types: ["script"]
  },
  ["blocking"]
);

if(config.websql){
	window.db = openDatabase('SIPD', '1.0', 'sipd database', 50 * 1024 * 1024);
	db.transaction(function (tx) {
		tx.executeSql('CREATE TABLE IF NOT EXISTS sipd (key, data)', [], function(tx, success){
			// console.log('success', success);
		}, function(tx, error){
			console.log('error', error);
		});
	});
}


chrome.runtime.onMessage.addListener( function(request, sender, sendResponse) {
	console.log('request & sender', request, sender);
	var type = request.message.type;
	if(type == 'actions'){
		if(config.websql){
			var actions = request.message.content.key;
			var proses = [];
			if(actions == 'get_ssh'){
				var url_ssh = config.sipd_url+"daerah/main/budget/dashboard-komponen/"+config.tahun_anggaran+"/unit/"+config.id_daerah+"/0";
				chrome.tabs.create({ url: url_ssh });
				proses = [
					{ login: 0 },
					{ get_ssh: 0 }
				];
			}else if(actions == 'login_operator'){
				var id_skpd = '';
				var url_ssh = config.sipd_url+"daerah/main/budget/dashboard/"+config.tahun_anggaran+"/unit/"+config.id_daerah+"/"+id_skpd;
				chrome.tabs.create({ url: url_ssh });
				proses = [
					{ login: 0 }
				];
			}
			setDB({
				key: actions,
				data: {
					status: 'active',
					proses: proses
				}
			})
			.then(function(){
				// getDB({
				// 	key: actions,
				// 	debug: true
				// });
			});
		}
	}else if(type == 'get-actions'){
		if(config.websql){
			getDB({
				// debug: true
			})
			.then(function(ret){
				console.log(type, ret);
				var options = {
					type: 'response-actions',
					data: ret,
					tab: sender.tab
				};
				sendMessageTabActive(options);
			});
		}
	}else if(type == 'run-actions'){
		if(config.websql){
			var actions = request.message.content.key;
			var data = request.message.content.data;
			var options = {
				key: actions,
				data: data
			};
			console.log('run-actions', options)
			setDB(options)
			.then(function(){
				// getDB({
				// 	key: actions,
				// 	debug: true
				// });
			});
		}
	}else if(type == 'get-url'){
		relayAjax({
		    url: request.message.content.url,
		    type: request.message.content.type,
		    data: request.message.content.data,
		    dataType: 'json',
		    success:function(ret){
		    	if(request.message.content.return){
			     	var options = {
			     		type: 'response-fecth-url',
			     		data: ret,
			     		tab: sender.tab
			     	}
			     	sendMessageTabActive(options);
			    }
		        // console.log(ret, request.message.content);
		        console.log(ret);
		    },
		    error:function(){
		        alert("Error");
		    }      
		});
	}
	return sendResponse("THANKS from background!");
});